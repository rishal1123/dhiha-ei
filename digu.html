<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Landscape-optimized viewport for mobile -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS PWA settings - landscape orientation -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Thaasbai">
    <meta name="apple-mobile-web-app-orientations" content="landscape">

    <!-- Android PWA settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#001825">
    <meta name="msapplication-navbutton-color" content="#001825">
    <meta name="msapplication-TileColor" content="#001825">

    <!-- Screen orientation hint -->
    <meta name="screen-orientation" content="landscape">
    <meta name="x5-orientation" content="landscape">
    <meta name="x5-fullscreen" content="true">

    <!-- Prevent text size adjustment -->
    <meta name="format-detection" content="telephone=no">

    <!-- iOS icons -->
    <link rel="apple-touch-icon" href="icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
    <link rel="apple-touch-icon-precomposed" href="icons/icon-180x180.png">

    <!-- Safari Pinned Tab Icon -->
    <link rel="mask-icon" href="icons/icon.svg" color="#006994">

    <!-- Standard favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">

    <!-- Splash screens for iOS (landscape orientation) -->
    <!-- iPhone 15 Pro Max -->
    <link rel="apple-touch-startup-image" href="splash/splash-iphone-15-pro-max-2796x1290.png"
        media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <!-- iPhone 14/13/12 -->
    <link rel="apple-touch-startup-image" href="splash/splash-iphone-14-13-12-2532x1170.png"
        media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <!-- iPhone 11 Pro/X -->
    <link rel="apple-touch-startup-image" href="splash/splash-iphone-11-pro-x-2436x1125.png"
        media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <!-- iPhone 11/XR -->
    <link rel="apple-touch-startup-image" href="splash/splash-iphone-11-xr-1792x828.png"
        media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPhone SE/8 -->
    <link rel="apple-touch-startup-image" href="splash/splash-iphone-se-8-1334x750.png"
        media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad Pro 12.9" -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-pro-12.9-2732x2048.png"
        media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad Pro 11" -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-pro-11-2388x1668.png"
        media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad Air -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-air-2360x1640.png"
        media="(device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad 10.2" -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-10.2-2160x1620.png"
        media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad mini -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-mini-2266x1488.png"
        media="(device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <!-- iPad 9.7" -->
    <link rel="apple-touch-startup-image" href="splash/splash-ipad-9.7-2048x1536.png"
        media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">

    <title>Digu - Thaasbai</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/base.css?v=8">
    <link rel="stylesheet" href="css/digu.css?v=31">

    <!-- Socket.IO for multiplayer -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Service Worker Registration with Auto-Update -->
    <script>
        // Set current game for bundle.js
        window.currentGame = 'digu';

        // Register service worker for PWA with update checking
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);

                        // Check for updates on every page load
                        registration.update();

                        // Check for updates periodically (every 5 minutes)
                        setInterval(() => {
                            registration.update();
                        }, 5 * 60 * 1000);

                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('New service worker installing...');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available, reload to activate
                                    console.log('New version available, reloading...');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });

                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'SW_UPDATED') {
                        console.log('Service worker updated to v' + event.data.version);
                        // Optionally reload or notify user
                    }
                });

                // Handle controller change (new SW took over)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('New service worker activated, reloading...');
                    window.location.reload();
                });
            });
        }

        // Lock screen orientation to landscape
        function lockLandscape() {
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {
                    // Orientation lock not supported or denied
                    console.log('Orientation lock not available');
                });
            }
        }

        // Try to lock on load and fullscreen
        document.addEventListener('DOMContentLoaded', lockLandscape);
        document.addEventListener('fullscreenchange', lockLandscape);
        document.addEventListener('webkitfullscreenchange', lockLandscape);
    </script>
</head>

<body>
    <!-- Full-screen background that fills viewport regardless of game scale -->
    <div id="game-background"></div>

    <header id="game-header">
        <h1>Thaasbai</h1>
        <div id="current-game-name">Digu</div>
        <div id="game-status"></div>
    </header>

    <!-- Digu Game Board - Bootstrap Grid - Full viewport -->
    <main id="digu-game-board" class="container-fluid p-0 game-background">
            <div class="row h-5"><div class="col"></div></div>
            <div class="row h-90">
                    <div class="col-1"></div>
                    <div class="col">

                        <!-- Row 1: Future use | Partner | Match Stats -->
                        <div class="row" style="height: 15%;">
                                    <div class="col">
                                        <div id="future-use"></div>
                                    </div>
                                    <div class="col text-center">
                                        <div id="digu-player-2"
                                            class="digu-player top team-a d-flex flex-column align-items-center">
                                            <div class="digu-avatar">
                                                <div class="digu-avatar-icon"></div>
                                            </div>
                                            <div class="digu-team-label">Partner</div>
                                            <div class="digu-player-label">Player 3</div>
                                            <div class="digu-shuffle-count" id="digu-shuffle-count-2">Shuffle: 0</div>
                                        </div>
                                    </div>
                                    <div class="col justify-content-start">
                                        <div id="digu-scores">
                                            <div class="digu-scores-title">Match Stats</div>
                                            <div class="digu-match-info">Games: <span id="digu-games-count">0</span>
                                            </div>
                                            <div class="digu-team-scores">
                                                <div class="digu-team-score team-a d-flex justify-content-between">
                                                    <span class="team-name">Your Team</span>
                                                    <span class="team-wins-value" id="team-a-wins">0</span>
                                                    <span class="team-score-value" id="team-a-score">0</span>
                                                </div>
                                                <div class="digu-team-score team-b d-flex justify-content-between">
                                                    <span class="team-name">Opponents</span>
                                                    <span class="team-wins-value" id="team-b-wins">0</span>
                                                    <span class="team-score-value" id="team-b-score">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 2: Left Player | Drink Sponsor | Stock | Center | Discard | Food Sponsor | Right Player -->
                                <div class="row" style="height: 55%;">
                                    <div class="col-2 ">
                                        <div class="row h-100">
                                            <div
                                                class="col-6 col-md-12 d-flex justify-content-center align-items-center">
                                                <div class="sponsor-column" id="drink-sponsor">
                                                    <span class="sponsor-label">Drink</span>
                                                    <div class="drink-item"></div>
                                                </div>
                                            </div>
                                            <div
                                                class="col-6 col-md-12 d-flex justify-content-center align-items-center">
                                                <div id="digu-player-1"
                                                    class="digu-player left team-b d-flex flex-column align-items-center">
                                                    <div class="digu-avatar">
                                                        <div class="digu-avatar-icon"></div>
                                                    </div>
                                                    <div class="digu-team-label">Opponent</div>
                                                    <div class="digu-player-label">Player 2</div>
                                                    <div class="digu-shuffle-count" id="digu-shuffle-count-1">Shuffle: 0
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="col d-flex align-items-center justify-content-end">
                                        <div id="digu-stock" class="digu-pile clickable" title="Draw from deck"></div>
                                    </div>
                                    <div class="col d-flex flex-column align-items-center justify-content-center">
                                        <div id="digu-phase">Draw a card</div>
                                        <div id="table-sponsor" class="my-2">
                                            <div class="sponsor-logo ooredoo">
                                                <img src="icons/ooredoo-sponsor.svg" width="150" height="60"
                                                    alt="Ooredoo Maldives">
                                            </div>
                                        </div>
                                        <div id="digu-draw-notification" class="digu-draw-notification"></div>
                                        <button id="digu-btn" class="btn btn-warning fw-bold text-uppercase hidden"
                                            disabled>DIGU!</button>
                                    </div>
                                    <div class="col d-flex align-items-center justify-content-start">
                                        <div id="digu-discard" class="digu-pile clickable" title="Draw from discard">
                                            <div class="discard-card" id="digu-discard-top"></div>
                                        </div>
                                    </div>
                                    <div class="col-2 ">
                                        <div class="row h-100">
                                            <div
                                                class="col-6 col-md-12 d-flex justify-content-center align-items-center">
                                                <div class="sponsor-column" id="food-sponsor">
                                                    <span class="sponsor-label">Food</span>
                                                    <div class="food-item"></div>
                                                </div>
                                            </div>
                                            <div
                                                class="col-6 col-md-12 d-flex justify-content-center align-items-center">
                                                <div id="digu-player-3"
                                                    class="digu-player right team-b d-flex flex-column align-items-center">
                                                    <div class="digu-avatar">
                                                        <div class="digu-avatar-icon"></div>
                                                    </div>
                                                    <div class="digu-team-label">Opponent</div>
                                                    <div class="digu-player-label">Player 4</div>
                                                    <div class="digu-shuffle-count" id="digu-shuffle-count-3">Shuffle: 0
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 3: You/Shuffle | Player Hand | Buttons -->
                                <div class="row" style="height: 30%;">
                                    <div
                                        class="col-1 d-flex flex-column align-items-center justify-content-center px-2">
                                        <div style="margin: 10px;">
                                            <span class="digu-player-label">You</span>
                                            <br/>
                                            <br/>
                                            <div>
                                            <span class="digu-shuffle-count" id="digu-shuffle-count-0">Shuffle: 0</span>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="col d-flex align-items-center justify-content-center h-100">
                                        <div id="digu-player-0" class="digu-player bottom team-a">
                                            <div class="digu-player-hand"></div>
                                        </div>
                                    </div>
                                    <div
                                        class="col-1 d-flex flex-column align-items-center justify-content-center gap-1">
                                        <div style="margin:10px;">
                                            <button id="new-game-btn-inline" class="btn btn-sm btn-outline-light">New
                                                Game</button>
                                                <br/>
                                                <br/>
                                            <button id="menu-btn-inline"
                                                class="btn btn-sm btn-outline-light">Menu</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Turn Indicator -->
                                <div id="digu-turn-indicator"></div>

                                <!-- End Game Result Modal -->
                                <div id="digu-result-modal" class="hidden">
                                    <div class="digu-result-content">
                                        <h2 id="digu-result-title">Game Over</h2>

                                        <!-- Match Stats Summary -->
                                        <div class="digu-match-stats">
                                            <div class="match-stats-row">
                                                <span class="match-stat-label">Matches Played:</span>
                                                <span id="digu-matches-played">0</span>
                                            </div>
                                            <div class="match-stats-row">
                                                <span class="match-stat-label">Your Team Wins:</span>
                                                <span id="digu-team-a-wins">0</span>
                                            </div>
                                            <div class="match-stats-row">
                                                <span class="match-stat-label">Opponents Wins:</span>
                                                <span id="digu-team-b-wins">0</span>
                                            </div>
                                            <div class="match-stats-row total">
                                                <span class="match-stat-label">Total Points - Your Team:</span>
                                                <span id="digu-total-points-a">0</span>
                                            </div>
                                            <div class="match-stats-row total">
                                                <span class="match-stat-label">Total Points - Opponents:</span>
                                                <span id="digu-total-points-b">0</span>
                                            </div>
                                        </div>

                                        <!-- This Game Score -->
                                        <div class="digu-game-score">
                                            <h3>This Game</h3>
                                            <div class="game-score-row winner">
                                                <span>Winning Team Bonus:</span>
                                                <span>+100</span>
                                            </div>
                                        </div>

                                        <!-- All Players Cards Display -->
                                        <div id="digu-result-players">
                                            <!-- Player cards will be inserted here dynamically -->
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="digu-result-buttons">
                                            <button id="digu-next-game-btn" class="digu-result-btn primary">Next
                                                Game</button>
                                            <button id="digu-new-match-btn" class="digu-result-btn">New Match</button>
                                            <button id="digu-exit-btn" class="digu-result-btn">Exit to Lobby</button>
                                        </div>
                                    </div>
                                </div>

                    </div>
                    <div class="col-1"></div>
                </div>
            <div class="row h-5"><div class="col"></div></div>
        </main>

    <!-- New game button -->
    <div id="controls">
        <button id="menu-btn">Menu</button>
        <button id="new-game-btn">New Game</button>
    </div>

    <!-- Game messages and overlays -->
    <div id="message-overlay" class="hidden">
        <div id="message-content">
            <h2 id="message-title"></h2>
            <p id="message-text"></p>
            <div id="message-buttons">
                <button id="message-button">Continue</button>
                <button id="message-button-secondary" class="hidden">End Game</button>
            </div>
        </div>
    </div>

    <!-- Lobby Overlay -->
        <div id="lobby-overlay">
            <div id="lobby-content">
                <!-- Game Lobby -->
                <div id="game-lobby">
                    <div class="lobby-header">
                        <h2 class="lobby-title">Digu</h2>
                    </div>
                    <p class="lobby-subtitle">Maldivian Card Game</p>

                    <!-- Main Menu -->
                    <div id="lobby-menu">
                        <button id="play-ai-btn" class="lobby-btn primary">Play vs AI</button>
                        <div class="lobby-divider"><span>or play online</span></div>
                        <button id="quick-match-btn" class="lobby-btn primary">Quick Match</button>
                        <button id="create-room-btn" class="lobby-btn">Create Private Room</button>
                        <div class="join-section">
                            <input type="text" id="room-code-input" placeholder="Room Code" maxlength="6"
                                autocomplete="off">
                            <button id="join-room-btn" class="lobby-btn">Join</button>
                        </div>
                        <button id="back-to-games" class="lobby-btn secondary"
                            onclick="window.location.href='index.html'">&#8592; Back</button>

                        <!-- Matchmaking Sponsor -->
                        <div id="matchmaking-sponsor" class="lobby-sponsor"
                            style="margin-top: calc(2 * var(--scale)); text-align: center;">
                            <span class="lobby-sponsor-label">Sponsored by</span>
                            <div class="lobby-sponsor-logo">
                                <!-- Sponsor logo will be inserted dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Digu Waiting Room -->
                <div id="digu-waiting-room" class="hidden">
                    <div class="room-header">
                        <h3>Room Code</h3>
                        <div id="digu-room-code-display"></div>
                        <button id="digu-copy-code-btn" class="copy-btn" title="Copy code">Copy</button>
                    </div>

                    <div id="digu-player-slots">
                        <div class="digu-slot-row">
                            <div class="digu-player-slot" data-position="0">
                                <span class="slot-number">1</span>
                                <span class="slot-status">Waiting...</span>
                                <span class="slot-name"></span>
                                <span class="slot-ready"></span>
                            </div>
                            <div class="digu-player-slot" data-position="1">
                                <span class="slot-number">2</span>
                                <span class="slot-status">Waiting...</span>
                                <span class="slot-name"></span>
                                <span class="slot-ready"></span>
                            </div>
                        </div>
                        <div class="digu-slot-row">
                            <div class="digu-player-slot" data-position="2">
                                <span class="slot-number">3</span>
                                <span class="slot-status">Waiting...</span>
                                <span class="slot-name"></span>
                                <span class="slot-ready"></span>
                            </div>
                            <div class="digu-player-slot" data-position="3">
                                <span class="slot-number">4</span>
                                <span class="slot-status">Waiting...</span>
                                <span class="slot-name"></span>
                                <span class="slot-ready"></span>
                            </div>
                        </div>
                    </div>

                    <p class="digu-room-hint">Minimum 2 players to start</p>

                    <div id="digu-waiting-room-actions">
                        <button id="digu-ready-btn" class="lobby-btn">Ready</button>
                        <button id="digu-start-game-btn" class="lobby-btn primary hidden">Start Game</button>
                        <button id="digu-leave-room-btn" class="lobby-btn secondary">Leave Room</button>
                    </div>

                    <div id="digu-connection-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Connected</span>
                    </div>

                    <!-- Waiting Room Sponsor -->
                    <div id="waiting-room-sponsor" class="lobby-sponsor"
                        style="margin-top: calc(2 * var(--scale)); text-align: center;">
                        <span class="lobby-sponsor-label">Sponsored by</span>
                        <div class="lobby-sponsor-logo">
                            <!-- Sponsor logo will be inserted dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Digu Matchmaking Queue -->
                <div id="digu-matchmaking-screen" class="hidden">
                    <div class="matchmaking-content">
                        <h3>Finding Players...</h3>
                        <div class="matchmaking-spinner"></div>
                        <div class="matchmaking-status">
                            <span id="digu-queue-count">0</span> / 4 players
                        </div>
                        <p class="matchmaking-hint">Game will start automatically when 4 players join</p>
                        <button id="digu-cancel-queue-btn" class="lobby-btn secondary">Cancel</button>
                    </div>
                </div>

                <!-- Name Input Modal -->
                <div id="name-input-modal" class="hidden">
                    <h3>Enter Your Name</h3>
                    <input type="text" id="player-name-input" placeholder="Your name" maxlength="10" autocomplete="off">
                    <div class="modal-actions">
                        <button id="name-cancel-btn" class="lobby-btn secondary">Cancel</button>
                        <button id="name-confirm-btn" class="lobby-btn primary">Confirm</button>
                    </div>
                </div>

                <!-- Error Display -->
                <div id="lobby-error" class="hidden"></div>
            </div>
        </div>

        <!-- Multiplayer Status Bar (shown during game) -->
        <div id="multiplayer-status" class="hidden">
            <span id="mp-room-code"></span>
            <span id="mp-timer" class="hidden">&#9201;&#65039; <span id="mp-timer-value">15:00</span></span>
            <span id="mp-turn-indicator"></span>
            <button id="mp-leave-btn" class="mp-btn">Leave</button>
        </div>

        <!-- Rotate Device Overlay (portrait mode on mobile) -->
        <div id="rotate-overlay">
            <div class="rotate-content">
                <div class="rotate-icon">
                    <img src="icons/rotate-device.svg" width="80" height="80" alt="Rotate device">
                </div>
                <h2>Rotate Your Device</h2>
                <p>Thaasbai is best played in landscape mode</p>
                <button id="play-portrait-btn" class="rotate-dismiss-btn">Play in Portrait Anyway</button>
            </div>
        </div>

        <!-- Install PWA Prompt -->
        <div id="install-prompt" class="hidden">
            <div class="install-content">
                <span>Install Thaasbai for the best experience</span>
                <button id="install-btn" class="install-btn">Install</button>
                <button id="install-dismiss" class="install-dismiss">&times;</button>
            </div>
        </div>

        <!-- Digu game bundle (self-contained) -->
        <script src="js/digu-bundle.js?v=1"></script>
        <!-- Digu-specific rendering module -->
        <script src="js/digu.js?v=2"></script>

        <!-- PWA Install Handler -->
        <script>
            let deferredPrompt;

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;

                // Show install prompt after a delay
                setTimeout(() => {
                    const prompt = document.getElementById('install-prompt');
                    if (prompt && !localStorage.getItem('pwaInstallDismissed')) {
                        prompt.classList.remove('hidden');
                    }
                }, 3000);
            });

            document.getElementById('install-btn')?.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('Install prompt outcome:', outcome);
                    deferredPrompt = null;
                }
                document.getElementById('install-prompt')?.classList.add('hidden');
            });

            document.getElementById('install-dismiss')?.addEventListener('click', () => {
                document.getElementById('install-prompt')?.classList.add('hidden');
                localStorage.setItem('pwaInstallDismissed', 'true');
            });

            // Hide install prompt if already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                const prompt = document.getElementById('install-prompt');
                if (prompt) prompt.classList.add('hidden');
            }
        </script>

</body>

</html>