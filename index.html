<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Landscape-optimized viewport for mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Android PWA settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#001825">
    <meta name="msapplication-navbutton-color" content="#001825">
    <meta name="msapplication-TileColor" content="#001825">

    <!-- Screen orientation hint -->
    <meta name="screen-orientation" content="landscape">
    <meta name="x5-orientation" content="landscape">
    <meta name="x5-fullscreen" content="true">

    <!-- Prevent text size adjustment -->
    <meta name="format-detection" content="telephone=no">

    <!-- Standard favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">

    <title>Thaasbai - Maldivian Card Games</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/base.css?v=11">

    <!-- Service Worker Registration with Auto-Update -->
    <script>
        // Register service worker for PWA with update checking
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);

                        // Check for updates on every page load
                        registration.update();

                        // Check for updates periodically (every 5 minutes)
                        setInterval(() => {
                            registration.update();
                        }, 5 * 60 * 1000);

                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('New service worker installing...');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available, reload to activate
                                    console.log('New version available, reloading...');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });

                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'SW_UPDATED') {
                        console.log('Service worker updated to v' + event.data.version);
                        // Optionally reload or notify user
                    }
                });

                // Handle controller change (new SW took over)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('New service worker activated, reloading...');
                    window.location.reload();
                });
            });
        }

        // Lock screen orientation to landscape
        function lockLandscape() {
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {
                    // Orientation lock not supported or denied
                    console.log('Orientation lock not available');
                });
            }
        }

        // Try to lock on load and fullscreen
        document.addEventListener('DOMContentLoaded', lockLandscape);
        document.addEventListener('fullscreenchange', lockLandscape);
        document.addEventListener('webkitfullscreenchange', lockLandscape);
    </script>
</head>
<body>
    <!-- Full-screen background that fills viewport regardless of game scale -->
    <div id="game-background"></div>

    <div id="viewport-wrapper">
    <!-- Game Selection Screen -->
    <div id="lobby-overlay" class="game-selection-page">
        <!-- Language Switcher -->
        <div id="lang-switcher-container"></div>

        <div id="lobby-content">
            <div id="game-selection">
                <h2 class="lobby-title" data-i18n="home.title">Thaasbai</h2>
                <p class="lobby-subtitle" data-i18n="home.subtitle">Maldivian Card Games</p>

                <div class="game-cards">
                    <div class="game-card" data-game="dhiha-ei">
                        <div class="game-card-icon">&#127183;</div>
                        <h3 class="game-card-title" data-i18n="home.dhihaEi">Dhiha Ei</h3>
                        <p class="game-card-desc" data-i18n="home.dhihaEiDesc">Classic trick-taking game for 4 players in teams</p>
                        <button class="btn btn-warning w-100" onclick="window.location.href='dhiha-ei.html'" data-i18n="home.playNow">Play</button>
                    </div>
                    <div class="game-card" data-game="digu">
                        <div class="game-card-icon">&#127156;</div>
                        <h3 class="game-card-title" data-i18n="home.digu">Digu</h3>
                        <p class="game-card-desc" data-i18n="home.diguDesc">Rummy-style card matching game (2-4 players)</p>
                        <button class="btn btn-warning w-100" onclick="window.location.href='digu.html'" data-i18n="home.playNow">Play</button>
                    </div>
                    <div class="game-card coming-soon" data-game="bondi">
                        <div class="coming-soon-badge" data-i18n="home.comingSoon">Coming Soon</div>
                        <div class="game-card-icon">&#127919;</div>
                        <h3 class="game-card-title">Bondi</h3>
                        <p class="game-card-desc">Traditional Maldivian card game</p>
                        <button class="btn btn-secondary w-100" disabled data-i18n="home.comingSoon">Coming Soon</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rotate Device Overlay (portrait mode on mobile) -->
    <div id="rotate-overlay">
        <div class="rotate-content">
            <div class="rotate-icon">
                <img src="icons/rotate-device.svg" width="80" height="80" alt="Rotate device">
            </div>
            <h2>Rotate Your Device</h2>
            <p>Thaasbai is best played in landscape mode</p>
            <button id="play-portrait-btn" class="btn btn-outline-light">Play in Portrait Anyway</button>
        </div>
    </div>

    <!-- Install PWA Prompt -->
    <div id="install-prompt" class="hidden">
        <div class="install-content">
            <span>Install Thaasbai for the best experience</span>
            <button id="install-btn" class="install-btn">Install</button>
            <button id="install-dismiss" class="install-dismiss">&times;</button>
        </div>
    </div>

    <!-- PWA Install Handler -->
    <script>
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install prompt after a delay
            setTimeout(() => {
                const prompt = document.getElementById('install-prompt');
                if (prompt && !localStorage.getItem('pwaInstallDismissed')) {
                    prompt.classList.remove('hidden');
                }
            }, 3000);
        });

        document.getElementById('install-btn')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('Install prompt outcome:', outcome);
                deferredPrompt = null;
            }
            document.getElementById('install-prompt')?.classList.add('hidden');
        });

        document.getElementById('install-dismiss')?.addEventListener('click', () => {
            document.getElementById('install-prompt')?.classList.add('hidden');
            localStorage.setItem('pwaInstallDismissed', 'true');
        });

        // Hide install prompt if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            const prompt = document.getElementById('install-prompt');
            if (prompt) prompt.classList.add('hidden');
        }

        // Handle rotate overlay dismiss
        document.getElementById('play-portrait-btn')?.addEventListener('click', () => {
            document.getElementById('rotate-overlay')?.classList.add('dismissed');
            localStorage.setItem('rotateOverlayDismissed', 'true');
        });

        // Check if rotate overlay was previously dismissed
        if (localStorage.getItem('rotateOverlayDismissed')) {
            document.getElementById('rotate-overlay')?.classList.add('dismissed');
        }
    </script>

    <!-- Internationalization (i18n) -->
    <script src="js/i18n.js?v=1"></script>

    <!-- Initialize i18n -->
    <script>
        // Initialize internationalization
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof I18n !== 'undefined') {
                await I18n.init();
                I18n.createLanguageSwitcher('lang-switcher-container');
            }
        });
    </script>
    </div><!-- end viewport-wrapper -->
</body>
</html>
